# Modbus 智能扫描工具 - 需求梳理文档

## 一、产品概述

### 1.1 产品定位
面向工程现场的 Modbus 智能扫描与识别工具，解决未知 Modbus 设备参数与地址识别问题。

### 1.2 核心价值
- **效率提升**：自动化扫描替代手动试错
- **风险降低**：可信度评估避免误判
- **经验复用**：将个人经验转化为工具能力
- **跨平台**：Windows / macOS / Linux 统一工具

---

## 二、功能需求

### 2.1 设备连接模块

#### 2.1.1 Modbus TCP 连接
- **输入参数**：
  - IP 地址（单 IP 或 IP 段）
  - 端口号（默认 502，可自定义）
- **功能要求**：
  - 支持单 IP 扫描
  - 支持 IP 段扫描（CIDR 格式）
  - 连接超时设置
  - 连接状态实时反馈

#### 2.1.2 Modbus RTU 连接
- **输入参数**：
  - 串口选择（COM 端口 / /dev/tty*）
  - 波特率（可选范围：9600, 19200, 38400, 57600, 115200）
  - 数据位（7, 8）
  - 校验位（None, Even, Odd）
  - 停止位（1, 2）
- **功能要求**：
  - 自动检测可用串口
  - 串口参数配置界面
  - 串口占用检测与提示
  - 串口异常自动恢复

---

### 2.2 扫描策略引擎（核心模块）

#### 2.2.1 Modbus TCP 扫描策略
- **扫描维度**：
  - Slave ID：1-247（可配置范围）
  - 功能码：01（线圈状态）、02（输入状态）、03（保持寄存器）、04（输入寄存器）
  - 寄存器地址：可配置起始地址和范围
- **扫描策略**：
  - 按优先级顺序扫描
  - 支持自定义扫描范围
  - 支持跳过已知无效参数

#### 2.2.2 Modbus RTU 扫描策略
- **参数组合生成**：
  - 内置工业常用参数模板
  - 优先级排序（常见参数优先）
  - 支持用户自定义优先级
- **快速失败机制**：
  - CRC 校验错误立即跳过
  - 无响应超时阈值（可配置）
  - 连续异常码判定（如连续 3 次异常码则跳过）
  - 无效参数组合快速淘汰

#### 2.2.3 参数优先级策略
- **内置参数池**：
  - 9600-8-N-1（最常见）
  - 19200-8-E-1
  - 38400-8-N-1
  - 115200-8-N-1
  - 其他工业标准组合
- **厂家模板**：
  - 支持导入厂家常用参数模板
  - 支持用户保存自定义模板
- **智能排序**：
  - 历史成功参数优先
  - 用户标记常用参数优先

---

### 2.3 通讯协议层

#### 2.3.1 Modbus 协议实现
- **功能码支持**：
  - 01: Read Coils
  - 02: Read Discrete Inputs
  - 03: Read Holding Registers
  - 04: Read Input Registers
- **协议特性**：
  - 完整的 Modbus RTU 帧格式（含 CRC）
  - 完整的 Modbus TCP 帧格式（含 MBAP）
  - 异常码识别与处理
  - 超时处理机制

#### 2.3.2 通讯安全
- **只读模式**：
  - 默认仅使用读功能码
  - 禁止写操作（05, 06, 15, 16）
- **扫描限速**：
  - 可配置请求间隔（默认 50ms）
  - 防止设备过载
  - 支持暂停/恢复

---

### 2.4 结果分析与可信度评估

#### 2.4.1 可信度评分模型
- **评分维度**：
  - **响应一致性**（权重 40%）
    - 多次请求响应格式一致
    - 数据长度符合预期
  - **多功能码验证**（权重 30%）
    - 多个功能码均能成功读取
    - 数据逻辑一致性
  - **数据稳定性**（权重 30%）
    - 连续读取数据变化合理
    - 无异常跳变
- **可信度等级**：
  - **高可信**（80-100 分）：推荐使用
  - **中可信**（60-79 分）：建议验证
  - **低可信**（<60 分）：需人工确认

#### 2.4.2 结果过滤
- 过滤噪声响应
- 过滤假响应（格式错误）
- 过滤异常码响应
- 保留最佳参数组合

---

### 2.5 UI 展示与交互

#### 2.5.1 主界面布局
- **左侧面板**：设备连接与扫描配置
  - 连接模式选择（TCP / RTU）
  - 参数配置区域
  - 扫描范围设置
  - 开始/暂停/停止按钮
- **中间面板**：扫描进度与日志
  - 实时进度条
  - 当前扫描参数显示
  - 已尝试/剩余组合数
  - 实时日志（可读格式，非 HEX）
  - 日志过滤与搜索
- **右侧面板**：结果与可信度
  - 设备信息卡片
  - 成功参数组合列表
  - 可信度评分显示
  - 可用寄存器列表

#### 2.5.2 扫描配置界面
- **基础模式**（新手友好）：
  - 最小化参数配置
  - 使用默认优先级
  - 一键启动扫描
- **高级模式**（工程师）：
  - 完整参数配置
  - 自定义扫描范围
  - 自定义优先级
  - 超时与限速设置

#### 2.5.3 UI 设计原则
- **工程感**：专业、克制、信息密度适中
- **可读性**：日志可读，避免纯 HEX 显示
- **实时性**：进度与状态实时更新
- **可控性**：支持暂停、跳过、停止

---

### 2.6 数据导出与复用

#### 2.6.1 扫描结果导出
- **导出格式**：
  - JSON（完整数据）
  - CSV（点表格式）
  - Excel（带格式）
  - 文本报告
- **导出内容**：
  - 设备连接参数
  - Slave ID
  - 可用功能码
  - 寄存器地址范围
  - 数据示例
  - 可信度评分

#### 2.6.2 数据复用
- **参数模板保存**：
  - 保存成功参数组合
  - 保存为设备模板
  - 支持模板导入/导出
- **历史记录**：
  - 保存扫描历史
  - 支持历史结果查看
  - 支持历史结果对比

---

## 三、非功能性需求

### 3.1 性能需求
- **响应速度**：
  - UI 操作响应 < 100ms
  - 扫描请求间隔可配置（默认 50ms）
  - 支持并发扫描（TCP 多 IP）
- **资源占用**：
  - 内存占用 < 200MB（正常扫描）
  - CPU 占用合理（不阻塞系统）

### 3.2 稳定性需求
- **异常处理**：
  - 串口异常自动恢复
  - 网络异常自动重试（可配置次数）
  - 扫描异常不崩溃
- **UI 响应**：
  - 扫描过程不阻塞 UI
  - 异步任务处理
  - 进度实时更新

### 3.3 安全性需求
- **设备安全**：
  - 默认只读模式
  - 禁止写寄存器操作
  - 扫描限速保护设备
- **数据安全**：
  - 本地数据存储加密（可选）
  - 敏感信息脱敏

### 3.4 兼容性需求
- **平台支持**：
  - Windows 10/11
  - macOS 10.15+
  - Linux（Debian/Ubuntu）
- **发布要求**：
  - 单文件发布（或最小依赖）
  - 无额外运行时依赖
  - 支持便携版

### 3.5 可维护性需求
- **代码质量**：
  - 模块化设计
  - 清晰的代码注释
  - 单元测试覆盖核心逻辑
- **日志系统**：
  - 结构化日志
  - 日志级别控制
  - 日志文件管理

---

## 四、技术约束

### 4.1 技术栈
- **UI 框架**：Avalonia（跨平台）
- **开发语言**：C#
- **Modbus 库**：需选择或实现 Modbus 协议库
- **串口库**：System.IO.Ports 或跨平台替代方案

### 4.2 架构要求
- **分层架构**：
  - UI 层（Avalonia）
  - 业务逻辑层
  - 协议层（Modbus）
  - 数据访问层
- **异步设计**：
  - 异步 I/O 操作
  - 异步 UI 更新
  - 任务取消支持

---

## 五、验收标准

### 5.1 功能验收
- ✅ 能够成功扫描 Modbus TCP 设备
- ✅ 能够成功扫描 Modbus RTU 设备
- ✅ 可信度评分准确反映结果质量
- ✅ 扫描结果可导出为多种格式
- ✅ UI 操作流畅，无阻塞

### 5.2 性能验收
- ✅ 扫描 1000 个参数组合时间 < 5 分钟（RTU）
- ✅ UI 响应时间 < 100ms
- ✅ 内存占用 < 200MB

### 5.3 兼容性验收
- ✅ Windows 10/11 正常运行
- ✅ macOS 正常运行
- ✅ Linux（Debian）正常运行

---

## 六、优先级划分

### P0（核心功能，必须实现）
1. Modbus TCP 基础扫描
2. Modbus RTU 基础扫描
3. 参数优先级策略
4. 基础可信度评估
5. 结果展示与导出

### P1（重要功能，建议实现）
1. 快速失败机制
2. 扫描过程可视化
3. 参数模板保存
4. 高级模式配置

### P2（增强功能，可选实现）
1. IP 段扫描
2. 历史记录管理
3. 日志过滤与搜索
4. 多格式导出

---

## 七、语言
1. 首先完成中文
2. 新增支持英文